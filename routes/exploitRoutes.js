const express = require('express');
const path = require('path');
const shell = require('shelljs');
const multer = require('multer');

const router = express.Router();

// Configuración de Multer para guardar archivos
const storage = multer.diskStorage({
  destination: './upload/', // Asegúrate de que esta carpeta exista
  filename: (req, file, cb) => {
    cb(null, file.originalname);
  },
});
const upload = multer({ storage });

// Ruta para subir el archivo
router.post('/upload', upload.single('file'), (req, res) => {
  if (!req.file) {
    return res.status(400).json({ error: 'No se ha subido ningún archivo' });
  }

  const filePath = path.join(__dirname, '..', 'upload', req.file.filename);
  res.json({
    message: 'Archivo subido correctamente',
    filePath,
  });
});

// Ruta para ejecutar el archivo subido
router.post('/execute', (req, res) => {
  const { filePath } = req.body;

  if (!filePath || !shell.test('-f', filePath)) {
    return res.status(400).json({ error: 'Archivo no encontrado o inválido' });
  }

  shell.chmod('+x', filePath); // Dar permisos de ejecución al archivo

  const output = shell.exec(filePath); // Ejecutar el archivo

  res.json({
    message: 'Archivo ejecutado exitosamente',
    output: output.stdout || output.stderr,
  });
});

module.exports = router;
